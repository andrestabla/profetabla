generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     String                @id @default(uuid())
  email                  String                @unique
  password               String
  name                   String?
  avatarUrl              String?
  role                   Role                  @default(STUDENT)
  isActive               Boolean               @default(true)
  createdAt              DateTime              @default(now())
  updatedAt              DateTime              @updatedAt
  age                    Int?
  bio                    String?
  linkedinUrl            String?
  portfolioUrl           String?
  interests              String[]
  emailVerified          DateTime?
  activityLogs           ActivityLog[]
  comments               Comment[]
  education              Education[]
  itemInteractions       ItemInteraction[]
  languages              Language[]
  createdLearningObjects LearningObject[]
  bookings               MentorshipBooking[]
  mentorshipSlots        MentorshipSlot[]
  projectsAsStudent      Project[]             @relation("StudentProjects")
  projectsAsTeacher      Project[]             @relation("TeacherProjects")
  projectApplications    ProjectApplication[]  @relation("StudentApplications")
  resourceInteractions   ResourceInteraction[]
  submissions            Submission[]
  workExperiences        WorkExperience[]
  assignedTasks          Task[]                @relation("TaskAssignees")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model PasswordResetToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Project {
  id                   String               @id @default(uuid())
  title                String
  type                 ProjectType          @default(PROJECT)
  description          String?
  industry             String?
  justification        String?
  objectives           String?
  deliverables         String?
  methodology          String?
  resourcesDescription String?
  schedule             String?
  budget               String?
  evaluation           String?
  kpis                 String?
  status               ProjectStatus        @default(OPEN)
  teacherId            String
  studentId            String?
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt
  googleDriveFolderId  String?
  assignments          Assignment[]
  mentorships          MentorshipBooking[]  @relation("ProjectMentorships")
  student              User?                @relation("StudentProjects", fields: [studentId], references: [id])
  teacher              User                 @relation("TeacherProjects", fields: [teacherId], references: [id])
  applications         ProjectApplication[]
  resources            Resource[]           @relation("ProjectResources")
  tasks                Task[]
  learningObjects      LearningObject[]     @relation("ProjectLearningObjects")
  tags                 Tag[]                @relation("ProjectToTag")

  @@index([teacherId])
  @@index([studentId])
  @@index([status])
}

model ProjectApplication {
  id         String            @id @default(uuid())
  projectId  String
  studentId  String
  motivation String?
  status     ApplicationStatus @default(PENDING)
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt
  project    Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)
  student    User              @relation("StudentApplications", fields: [studentId], references: [id])

  @@unique([projectId, studentId])
  @@index([status])
}

model Resource {
  id           String                @id @default(uuid())
  title        String
  description  String?
  presentation String?
  utility      String?
  url          String
  type         String                @default("ARTICLE")
  subject      String?
  competency   String?
  keywords     String[]
  projectId    String?
  categoryId   String
  createdAt    DateTime              @default(now())
  updatedAt    DateTime              @updatedAt
  category     ResourceCategory      @relation(fields: [categoryId], references: [id])
  project      Project?              @relation("ProjectResources", fields: [projectId], references: [id], onDelete: Cascade)
  interactions ResourceInteraction[]
  tasks        Task[]                @relation("TaskResources")
  comments     Comment[]             @relation("ResourceComments")

  @@index([projectId])
  @@index([categoryId])
}

model ResourceCategory {
  id        String     @id @default(uuid())
  name      String     @unique
  color     String     @default("blue")
  resources Resource[]
}

model ResourceInteraction {
  id          String   @id @default(uuid())
  userId      String
  resourceId  String
  isCompleted Boolean  @default(false)
  isFavorite  Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  resource    Resource @relation(fields: [resourceId], references: [id])
  user        User     @relation(fields: [userId], references: [id])

  @@unique([userId, resourceId])
}

model MentorshipSlot {
  id         String             @id @default(uuid())
  teacherId  String
  startTime  DateTime
  endTime    DateTime
  isBooked   Boolean            @default(false)
  meetingUrl String?
  version    Int                @default(0)
  createdAt  DateTime           @default(now())
  updatedAt  DateTime           @updatedAt
  booking    MentorshipBooking?
  teacher    User               @relation(fields: [teacherId], references: [id])
}

model MentorshipBooking {
  id          String         @id @default(uuid())
  slotId      String         @unique
  studentId   String
  projectId   String?
  note        String?
  status      BookingStatus  @default(PENDING)
  initiatedBy Role           @default(STUDENT)
  minutes     String?
  agreements  String?
  rating      Int?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  project     Project?       @relation("ProjectMentorships", fields: [projectId], references: [id])
  slot        MentorshipSlot @relation(fields: [slotId], references: [id])
  student     User           @relation(fields: [studentId], references: [id])

  @@index([studentId])
  @@index([projectId])
  @@index([status])
}

model Task {
  id                 String     @id @default(uuid())
  title              String
  description        String?
  status             TaskStatus @default(TODO)
  priority           Priority   @default(MEDIUM)
  projectId          String
  dueDate            DateTime?
  isApproved         Boolean    @default(false)
  approvalNotes      String?
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt
  deliverable        String?
  evaluationCriteria String?
  comments           Comment[]
  project            Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  assignees          User[]     @relation("TaskAssignees")
  resources          Resource[] @relation("TaskResources")
  tags               Tag[]      @relation("TaskTags")
  assignment         Assignment?

  @@index([projectId])
  @@index([status])
}

model Comment {
  id               String          @id @default(uuid())
  content          String
  taskId           String?
  learningObjectId String?
  authorId         String
  createdAt        DateTime        @default(now())
  author           User            @relation(fields: [authorId], references: [id])
  learningObject   LearningObject? @relation(fields: [learningObjectId], references: [id], onDelete: Cascade)
  task             Task?           @relation(fields: [taskId], references: [id], onDelete: Cascade)
  resourceId       String?
  resource         Resource?       @relation("ResourceComments", fields: [resourceId], references: [id], onDelete: Cascade)
}

model Tag {
  id       String    @id @default(uuid())
  name     String
  color    String    @default("blue")
  projects Project[] @relation("ProjectToTag")
  tasks    Task[]    @relation("TaskTags")
}

model Assignment {
  id                 String       @id @default(uuid())
  title              String
  description        String?
  dueDate            DateTime?
  projectId          String
  taskId             String?      @unique
  evaluationCriteria String?
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt
  project            Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  task               Task?        @relation(fields: [taskId], references: [id])
  submissions        Submission[]
  rubricItems        RubricItem[]
}

model Submission {
  id           String     @id @default(uuid())
  assignmentId String
  studentId    String
  fileUrl      String
  fileName     String
  fileType     String?
  fileSize     Int?
  grade        Int?
  feedback     String?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  assignment   Assignment @relation(fields: [assignmentId], references: [id])
  student      User       @relation(fields: [studentId], references: [id])
  rubricScores RubricScore[]
}

model RubricItem {
  id           String        @id @default(uuid())
  assignmentId String
  criterion    String
  maxPoints    Int
  order        Int           @default(0)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  assignment   Assignment    @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  scores       RubricScore[]

  @@index([assignmentId])
}

model RubricScore {
  id           String     @id @default(uuid())
  submissionId String
  rubricItemId String
  score        Int
  feedback     String?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  rubricItem   RubricItem @relation(fields: [rubricItemId], references: [id], onDelete: Cascade)
  submission   Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  @@unique([submissionId, rubricItemId])
}

model ActivityLog {
  id          String   @id @default(uuid())
  userId      String?
  level       String   @default("INFO")
  action      String
  description String?
  metadata    Json?
  createdAt   DateTime @default(now())
  user        User?    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([action])
}

model LearningObject {
  id          String         @id @default(uuid())
  title       String
  description String?
  subject     String
  competency  String?
  keywords    String[]
  presentation String?
  utility      String?
  authorId    String
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  comments    Comment[]
  author      User           @relation(fields: [authorId], references: [id])
  items       ResourceItem[]
  projects    Project[]      @relation("ProjectLearningObjects")

  @@index([authorId])
}

model ResourceItem {
  id               String            @id @default(uuid())
  title            String
  type             ItemType          @default(LINK)
  url              String
  presentation     String?
  utility          String?
  subject          String?
  competency       String?
  keywords         String[]
  order            Int               @default(0)
  learningObjectId String
  interactions     ItemInteraction[]
  learningObject   LearningObject    @relation(fields: [learningObjectId], references: [id], onDelete: Cascade)
}

model ItemInteraction {
  id             String       @id @default(uuid())
  userId         String
  resourceItemId String
  isCompleted    Boolean      @default(false)
  timeSpentSecs  Int          @default(0)
  lastAccessed   DateTime     @default(now())
  resourceItem   ResourceItem @relation(fields: [resourceItemId], references: [id])
  user           User         @relation(fields: [userId], references: [id])

  @@unique([userId, resourceItemId])
}

model PlatformConfig {
  id                            String   @id @default("global-config")
  institutionName               String   @default("Profe Tabla")
  logoUrl                       String?
  faviconUrl                    String?
  themePreset                   String   @default("DEFAULT")
  primaryColor                  String   @default("#2563EB")
  secondaryColor                String   @default("#475569")
  accentColor                   String   @default("#F59E0B")
  fontFamily                    String   @default("Inter")
  borderRadius                  String   @default("0.5rem")
  loginLayout                   String   @default("SPLIT")
  loginBgUrl                    String?
  loginMessage                  String?
  customCss                     String?
  geminiApiKey                  String?
  geminiModel                   String   @default("gemini-pro")
  openaiApiKey                  String?
  openaiModel                   String   @default("gpt-4o-mini")
  aiProvider                    String   @default("GEMINI")
  youtubeApiKey                 String?
  googleClientId                String?
  googleClientSecret            String?
  googleDriveClientId           String?
  googleDriveClientSecret       String?
  googleDriveFolderId           String?
  smtpHost                      String?
  smtpPort                      Int      @default(587)
  smtpUser                      String?
  smtpPassword                  String?
  smtpSenderName                String?
  smtpFrom                      String   @default("noreply@profetabla.com")
  updatedAt                     DateTime @updatedAt
  aiInstructions                String?  @default("Actúa como un experto Diseñador Instruccional...")
  aiSearchEnabled               Boolean  @default(false)
  aiTone                        String   @default("ACADEMIC")
  googleDriveServiceAccountJson String?
  googleDriveAdminEmail         String?
  
  // Cloudflare R2 Integration
  r2AccountId                   String?
  r2AccessKeyId                 String?
  r2SecretAccessKey             String?
  r2BucketName                  String?
  
  loadingUrl                    String?  @default("https://profetabla.s3.us-east-1.amazonaws.com/coaching.gif")
}

model WorkExperience {
  id          String    @id @default(uuid())
  userId      String
  position    String
  company     String
  startDate   DateTime
  endDate     DateTime?
  description String?
  createdAt   DateTime  @default(now())
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Education {
  id           String    @id @default(uuid())
  userId       String
  institution  String
  degree       String
  fieldOfStudy String?
  startDate    DateTime
  endDate      DateTime?
  createdAt    DateTime  @default(now())
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Language {
  id     String @id @default(uuid())
  userId String
  name   String
  level  String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

enum Role {
  STUDENT
  TEACHER
  ADMIN
}

enum ProjectStatus {
  OPEN
  IN_PROGRESS
  COMPLETED
}

enum ProjectType {
  PROJECT
  CHALLENGE
  PROBLEM
}

enum ApplicationStatus {
  PENDING
  ACCEPTED
  REJECTED
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  DONE
}

enum BookingStatus {
  PENDING
  CONFIRMED
  REJECTED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
}

enum ItemType {
  PDF
  VIDEO
  EMBED
  DRIVE
  S3
  LINK
  DOC
}
