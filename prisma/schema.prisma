
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum Role {
  STUDENT
  TEACHER
  ADMIN
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  DONE
}

enum BookingStatus {
  PENDING
  CONFIRMED
  REJECTED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String   
  name      String?
  avatarUrl String?  // HU-02
  role      Role     @default(STUDENT)
  
  projects        Project[]        @relation("StudentProjects")
  mentorshipSlots MentorshipSlot[] 
  bookings        MentorshipBooking[]
  activityLogs    ActivityLog[]    // HU-04
  comments        Comment[]        // HU-10
  assignedTasks   Task[]           @relation("TaskAssignees") // HU-09
  submissions     Submission[]
  resourceInteractions ResourceInteraction[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Project {
  id          String   @id @default(uuid())
  title       String
  description String?
  studentId   String
  student     User     @relation("StudentProjects", fields: [studentId], references: [id])
  tasks       Task[]
  tags        Tag[]
  assignments Assignment[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model ResourceCategory {
  id        String   @id @default(uuid())
  name      String
  color     String   @default("blue")
  
  resources Resource[]
  
  createdAt DateTime @default(now())
}

model Resource {
  id          String   @id @default(uuid())
  title       String
  description String?
  url         String
  type        String   @default("ARTICLE") // VIDEO, ARTICLE, FILE
  
  categoryId  String
  category    ResourceCategory @relation(fields: [categoryId], references: [id])
  
  tasks       Task[]   @relation("TaskResources") // HU-20

  interactions ResourceInteraction[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model ResourceInteraction {
  id         String   @id @default(uuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  resourceId String
  resource   Resource @relation(fields: [resourceId], references: [id])
  
  isViewed   Boolean  @default(false)
  isFavorite Boolean  @default(false)
  
  viewedAt   DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  @@unique([userId, resourceId])
}

model Assignment {
  id          String   @id @default(uuid())
  title       String
  description String?
  dueDate     DateTime
  
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  submissions Submission[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Submission {
  id           String   @id @default(uuid())
  fileUrl      String   // Base64 for MVP
  fileName     String
  fileType     String
  fileSize     Int

  assignmentId String
  assignment   Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)

  studentId    String
  student      User     @relation(fields: [studentId], references: [id])
  
  grade        Float?
  feedback     String?

  submittedAt  DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model Task {
  id          String     @id @default(uuid())
  title       String
  description String?
  status      TaskStatus @default(TODO)
  priority    Priority   @default(MEDIUM) // HU-07
  dueDate     DateTime?                   // HU-07
  
  isApproved    Boolean?   @default(false)     // HU-11
  approvalNotes String?                        // HU-11

  projectId   String
  project     Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  comments    Comment[]  // HU-10
  tags        Tag[]      // HU-09

  assignees   User[]     @relation("TaskAssignees") // HU-09
  resources   Resource[] @relation("TaskResources") // HU-20
  
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}

model Comment {
  id        String   @id @default(uuid())
  content   String
  taskId    String
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  
  createdAt DateTime @default(now())
}

model Tag {
  id        String   @id @default(uuid())
  name      String
  color     String   @default("blue") // e.g., "blue", "red", "green"
  
  tasks     Task[]
  projects  Project[]
}

model MentorshipSlot {
  id        String   @id @default(uuid())
  teacherId String
  teacher   User     @relation(fields: [teacherId], references: [id])
  startTime DateTime
  endTime   DateTime
  isBooked  Boolean  @default(false)
  
  meetingUrl String? // HU-24
  
  booking   MentorshipBooking?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model MentorshipBooking {
  id        String        @id @default(uuid())
  slotId    String        @unique
  slot      MentorshipSlot @relation(fields: [slotId], references: [id])
  studentId String
  student   User          @relation(fields: [studentId], references: [id])
  note      String?
  status    BookingStatus @default(PENDING)
  
  minutes     String?     // HU-26
  agreements  String?     // HU-26
  rating      Int?        // HU-27
  
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
}

// HU-04
model ActivityLog {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  action      String   // e.g., "UPLOAD_FILE", "COMPLETE_TASK"
  description String?
  
  createdAt   DateTime @default(now())
}

