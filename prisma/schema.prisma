generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ---------------------------------------------------------
// 1. ENUMS
// ---------------------------------------------------------
enum Role {
  STUDENT
  TEACHER
  ADMIN
}

enum ProjectStatus {
  OPEN         // Available for applications
  IN_PROGRESS  // Student assigned
  COMPLETED    // Finished
}

enum ApplicationStatus {
  PENDING
  ACCEPTED
  REJECTED
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  DONE
}

enum BookingStatus {
  PENDING
  CONFIRMED
  REJECTED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
}

// ---------------------------------------------------------
// 2. USER MODEL
// ---------------------------------------------------------
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String   
  name      String?
  avatarUrl String?  
  role      Role     @default(STUDENT)
  
  // Projects
  projectsAsStudent    Project[]            @relation("StudentProjects")
  projectsAsTeacher    Project[]            @relation("TeacherProjects")
  projectApplications  ProjectApplication[] @relation("StudentApplications")
  
  // Mentorship
  mentorshipSlots MentorshipSlot[] 
  bookings        MentorshipBooking[]

  // Activity & Other
  activityLogs    ActivityLog[]    
  comments        Comment[]        
  assignedTasks   Task[]           @relation("TaskAssignees") 
  submissions     Submission[]
  resourceInteractions ResourceInteraction[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ---------------------------------------------------------
// 3. PROJECT MODEL (The Pedagogical Core)
// ---------------------------------------------------------
model Project {
  id          String   @id @default(uuid())
  title       String
  description String?

  // PHASE 1: Justification & Content
  industry      String?  // e.g. "Fintech", "Health"
  justification String?  @db.Text
  objectives    String?  @db.Text
  deliverables  String?  @db.Text
  
  status        ProjectStatus @default(OPEN)

  // Actors
  teacherId   String
  teacher     User     @relation("TeacherProjects", fields: [teacherId], references: [id])
  
  studentId   String?  // Optional initially
  student     User?    @relation("StudentProjects", fields: [studentId], references: [id])

  // Applications (Matchmaking)
  applications ProjectApplication[] 

  // Ecosystem
  tasks       Task[]
  resources   Resource[]          @relation("ProjectResources") 
  mentorships MentorshipBooking[] @relation("ProjectMentorships")
  
  tags        Tag[]
  assignments Assignment[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ---------------------------------------------------------
// 4. MARKETPLACE / MATCHMAKING
// ---------------------------------------------------------
model ProjectApplication {
  id        String   @id @default(uuid())

  projectId String
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  studentId String
  student   User     @relation("StudentApplications", fields: [studentId], references: [id])

  motivation String? @db.Text 
  status     ApplicationStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([projectId, studentId]) 
}

// ---------------------------------------------------------
// 5. RESOURCES (Project Contextualized)
// ---------------------------------------------------------
model Resource {
  id          String   @id @default(uuid())
  title       String
  description String?
  url         String
  type        String   @default("ARTICLE") 
  
  projectId   String?
  project     Project? @relation("ProjectResources", fields: [projectId], references: [id], onDelete: Cascade)

  categoryId  String
  category    ResourceCategory @relation(fields: [categoryId], references: [id])
  tasks       Task[]   @relation("TaskResources") 
  interactions ResourceInteraction[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model ResourceCategory {
  id        String     @id @default(uuid())
  name      String     @unique
  color     String     @default("blue")
  resources Resource[]
}

model ResourceInteraction {
  id         String   @id @default(uuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  resourceId String
  resource   Resource @relation(fields: [resourceId], references: [id])
  
  isCompleted Boolean @default(false)
  isFavorite  Boolean @default(false)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([userId, resourceId])
}

// ---------------------------------------------------------
// 6. MENTORSHIP & SLOTS
// ---------------------------------------------------------
model MentorshipSlot {
  id        String   @id @default(uuid())
  teacherId String
  teacher   User     @relation(fields: [teacherId], references: [id])
  
  startTime DateTime
  endTime   DateTime
  isBooked  Boolean  @default(false)
  meetingUrl String?

  booking   MentorshipBooking?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model MentorshipBooking {
  id        String        @id @default(uuid())
  slotId    String        @unique
  slot      MentorshipSlot @relation(fields: [slotId], references: [id])
  
  studentId String
  student   User          @relation(fields: [studentId], references: [id])
  
  projectId String?
  project   Project?      @relation("ProjectMentorships", fields: [projectId], references: [id])

  note      String?
  status    BookingStatus @default(PENDING)
  
  minutes     String?     
  agreements  String?     
  rating      Int?        
  
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
}

// ---------------------------------------------------------
// 7. KANBAN & TASKS
// ---------------------------------------------------------
model Task {
  id          String   @id @default(uuid())
  title       String
  description String?
  status      TaskStatus @default(TODO)
  priority    Priority   @default(MEDIUM)
  
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  assignees   User[]   @relation("TaskAssignees")
  
  dueDate     DateTime?
  
  resources   Resource[] @relation("TaskResources")
  comments    Comment[]
  tags        Tag[]      @relation("TaskTags")
  
  // Approval System
  isApproved    Boolean @default(false)
  approvalNotes String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Comment {
  id        String   @id @default(uuid())
  content   String
  taskId    String
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  authorId  String
  author    User     @relation(fields: [authorId], references: [id])
  createdAt DateTime @default(now())
}

model Tag {
  id       String    @id @default(uuid())
  name     String
  color    String    @default("blue")
  tasks    Task[]    @relation("TaskTags")
  projects Project[]
}

// ---------------------------------------------------------
// 8. SUBMISSIONS & ETC
// ---------------------------------------------------------
model Assignment {
  id          String   @id @default(uuid())
  title       String
  description String?
  dueDate     DateTime?
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  submissions Submission[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Submission {
  id           String   @id @default(uuid())
  assignmentId String
  assignment   Assignment @relation(fields: [assignmentId], references: [id])
  studentId    String
  student      User       @relation(fields: [studentId], references: [id])
  
  fileUrl      String
  fileName     String
  fileType     String?
  fileSize     Int?
  
  grade        Int?
  feedback     String?
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model ActivityLog {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  action      String   // e.g., "CREATE_TASK", "MOVE_TASK", "UPLOAD_FILE"
  description String
  createdAt   DateTime @default(now())
}
